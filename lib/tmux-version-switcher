#!/usr/bin/env bash

set -e

tmuxvs:main() {
    SESSION="sync-$TMUXVS_TOOL"

    cmd="$1"
    args=("$@")

    if [[ ${#args[@]} -eq 0 ]]; then
        local error="tmuxvs:errorarg:$TMUXVS_TOOL"
        type "$error" &> /dev/null && "$error" || tmuxvs:errorarg
        exit;
    elif [[ "$cmd" != "run" ]] && [[ "$cmd" != "local" ]]; then
        local error="tmuxvs:errorarg:$TMUXVS_TOOL"
        type "$error" &> /dev/null && "$error" || tmuxvs:errorarg
        exit;
    elif [[ "$cmd" == "local" ]] && (( ${#args[@]} <= 1 )); then
        local error="tmuxvs:errorarg:local:$TMUXVS_TOOL"
        type "$error" &> /dev/null && "$error" || tmuxvs:errorarg:local
        exit;
    elif [[ "$cmd" == "run" ]] && (( ${#args[@]} <= 2 )); then
        local error="tmuxvs:errorarg:run:$TMUXVS_TOOL"
        type "$error" &> /dev/null && "$error" || tmuxvs:errorarg:run
        exit;
    fi

    tmux new-session -d -s $SESSION

    # NOTE: first command needs to have the target session specified, because
    # otherwise it chooses the last activate session and might break things there.

    tmux rename-window -t $SESSION:0 "$TMUXVS_TOOL"

    tmuxvs:setup-panes

    tmux select-layout tiled

    tmux set synchronize-panes on

    tmuxvs:run

    echo "Created session '$SESSION' and activated synchronize"

    tmux list-sessions

    tmux attach-session -t $SESSION
}

tmuxvs:run() {
    if [[ $cmd == "run" ]]; then
        local exec_cmd="${args[1]}"

        local command
        tmuxvs:run:$TMUXVS_TOOL "$exec_cmd"
        if [[ -n "$command" ]]; then
            tmux send-keys "$command" C-m
        fi
    fi
}

tmuxvs:setup-panes() {
    offset=1
    [[ $cmd == "run" ]] && offset=2

    for ((i = $offset; i < ${#args[@]}; i = i+1)); do
        local index=$(( i - $offset ))
        echo "$SESSION:0:$index ${args[$i]}"

        if (( $i > $offset )); then
            tmux split-window -h
        fi

        local command
        tmuxvs:local:$TMUXVS_TOOL
        if [[ -n "$command" ]]; then
            tmux send-keys "$command ${args[$i]}" C-m
        fi

    done
}


tmuxvs:errorarg:local() {
    cat <<EOM
Usage: $0 local [<version>]+
EOM
}

tmuxvs:errorarg:run() {
    cat <<EOM
Usage: $0 run '\$x = 23' [<version>]+
EOM
}

tmuxvs:errorarg() {
    cat <<EOM
Usage: $0 (local|run) <args>+
EOM
}

tmuxvs:main "$@"

